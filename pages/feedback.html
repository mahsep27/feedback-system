<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback - KEEP TUTORS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #5D2E46;
            --primary-dark: #4a2538;
            --accent: #F7941D;
            --accent-dark: #e8850a;
            --success: #10b981;
            --bg: #faf8f9;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --star-active: #F7941D;
            --star-inactive: #d4c5cb;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 20px; }
        .container { max-width: 720px; margin: 0 auto; }
        .header { display: flex;gap: 20px; alignt-item: center ;margin-bottom: 32px;padding-top: 20px;}
        .logo {flex-shrink: 0;}
        .logo img {height: 180px; width: auto;}
        .header-text {text-align: center;}
        .header-text h1 {font-size: 22px;font-weight: 600;color: var(--primary);margin-bottom: 6px;}
        .header-text p {color: var(--text-muted);font-size: 15px;}
        .card { background: var(--card); border-radius: 16px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 10px 40px rgba(0,0,0,0.05); }
        .form-section { margin-bottom: 28px; }
        .form-section:last-of-type { margin-bottom: 0; }
        .section-title { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; }
        .rating-group { margin-bottom: 24px; }
        .rating-group:last-child { margin-bottom: 0; }
        .rating-label { font-size: 15px; color: var(--text); margin-bottom: 10px; display: block; font-weight: 500; }
        .stars { display: flex; gap: 16px; flex-direction: row-reverse; justify-content: flex-end; }
        .stars input { display: none; }
        .stars label { cursor: pointer; font-size: 44px; color: var(--star-inactive); transition: color 0.15s ease, transform 0.15s ease; line-height: 1; }
        .stars label:hover, .stars label:hover ~ label, .stars input:checked ~ label { color: var(--star-active); }
        .stars label:hover { transform: scale(1.15); }
        .stars label::before { content: '‚òÖ'; }
        .rating-value { font-size: 13px; color: var(--text-muted); margin-top: 6px; min-height: 18px; }
        textarea { width: 100%; min-height: 100px; padding: 14px 16px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 15px; resize: vertical; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(247, 148, 29, 0.15); }
        textarea::placeholder { color: var(--text-muted); }
        input[type="email"] { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 15px; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        input[type="email"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(247, 148, 29, 0.15); }
        input[type="email"]::placeholder { color: var(--text-muted); }
        .dropdown-group { margin-bottom: 20px; }
        .custom-select { position: relative; width: 100%; }
        .select-selected { padding: 14px 16px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; background: white; display: flex; align-items: center; justify-content: space-between; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .select-selected:hover { border-color: var(--accent); }
        .select-selected.active { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(247, 148, 29, 0.15); border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .select-selected::after { content: ''; width: 10px; height: 10px; border-right: 2px solid var(--text-muted); border-bottom: 2px solid var(--text-muted); transform: rotate(45deg); transition: transform 0.2s ease; margin-left: 10px; flex-shrink: 0; }
        .select-selected.active::after { transform: rotate(-135deg); margin-top: 5px; }
        .select-selected .placeholder { color: var(--text-muted); }
        .select-selected .selected-text { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
        .select-selected .selected-emoji { font-size: 20px; flex-shrink: 0; }
        .select-selected .selected-label { color: var(--text); font-weight: 500; font-size: 14px; line-height: 1.4; }
        .select-items { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid var(--accent); border-top: none; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; z-index: 100; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .select-items.show { display: block; }
        .select-item { padding: 14px 16px; cursor: pointer; display: flex; align-items: flex-start; gap: 10px; transition: background 0.15s ease; border-bottom: 1px solid var(--border); }
        .select-item:last-child { border-bottom: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        .select-item:hover { background: #f1f5f9; }
        .select-item.selected { background: rgba(247, 148, 29, 0.08); }
        .item-number { background: var(--primary); color: white; width: 22px; height: 22px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
        .item-emoji { font-size: 18px; flex-shrink: 0; }
        .item-text { font-size: 14px; color: var(--text); line-height: 1.4; }
        .recommend-options { display: flex; gap: 12px; flex-wrap: wrap; }
        .recommend-option { flex: 1; min-width: 100px; }
        .recommend-option input { display: none; }
        .recommend-option label { display: block; padding: 14px 20px; text-align: center; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s ease; }
        .recommend-option input:checked + label { border-color: var(--accent); background: rgba(247, 148, 29, 0.08); color: var(--accent); }
        .recommend-option label:hover { border-color: var(--accent); }
        .submit-btn { width: 100%; padding: 16px 24px; background: var(--primary); color: white; border: none; border-radius: 10px; font-family: inherit; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s ease, transform 0.1s ease; margin-top: 28px; }
        .submit-btn:hover { background: var(--accent); }
        .submit-btn:active { transform: scale(0.98); }
        .submit-btn:disabled { background: var(--text-muted); cursor: not-allowed; }
        .divider { height: 1px; background: var(--border); margin: 28px 0; }
        .success-state, .invalid-state, .submitted-state, .loading-state { display: none; text-align: center; padding: 40px 20px; }
        .success-state.active, .invalid-state.active, .submitted-state.active, .loading-state.active { display: block; }
        .success-icon, .invalid-icon, .submitted-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; }
        .success-icon { background: var(--accent); }
        .invalid-icon { background: #fee2e2; }
        .submitted-icon { background: #dbeafe; }
        .success-icon svg, .invalid-icon svg, .submitted-icon svg { width: 40px; height: 40px; }
        .success-icon svg { color: white; }
        .invalid-icon svg { color: #dc2626; }
        .submitted-icon svg { color: var(--primary); }
        .success-state h2, .invalid-state h2, .submitted-state h2 { font-size: 24px; margin-bottom: 12px; color: var(--text); }
        .success-state p, .invalid-state p, .submitted-state p, .loading-state p { color: var(--text-muted); font-size: 15px; }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; }
        .error-message.active { display: block; }
        .loading .submit-btn { position: relative; color: transparent; }
        .loading .submit-btn::after { content: ''; position: absolute; width: 20px; height: 20px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .form-state { display: none; }
        .form-state.active { display: block; }
        @media (max-width: 480px) { .card { padding: 24px 20px; } .stars label { font-size: 36px; } .stars { gap: 8px; } .recommend-option { min-width: calc(50% - 6px); }  .header {flex-direction: column;text-align: center;}.header-text {text-align: center;}.logo img {height: 110px;}} }
    </style>
</head>
<body>
    <div class="container">    
        <div class="header">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/mahsep27/feedback-system/main/Logo.png" alt="KEEP TUTORS">
            </div>
            <div class="header-text">
                <h1 id="formTitle">Tuition Feedback</h1>
                <p>We'd love to hear about your experience</p>
            </div>
        </div>


        <div class="card">
            <div class="loading-state active" id="loadingState">
                <div class="loading-spinner"></div>
                <p>Loading feedback form...</p>
            </div>

            <div class="invalid-state" id="invalidState">
                <div class="invalid-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h2>Invalid Link</h2>
                <p id="invalidMessage">This feedback link appears to be invalid. Please use the link sent to you via WhatsApp.</p>
            </div>

            <div class="submitted-state" id="submittedState">
                <div class="submitted-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h2>Already Submitted</h2>
                <p>You have already submitted feedback for this session. Thank you!</p>
            </div>

            <div class="form-state" id="formState">
                <div class="error-message" id="errorMessage"></div>
                <form id="feedbackForm">
                    <div class="form-section">
                        <div class="section-title">Your Email</div>
                        <input type="email" name="email" placeholder="Enter your email address" required>
                    </div>

                    <div class="divider"></div>

                    <div class="form-section">
                        <div class="section-title" id="tutorSectionTitle">Rate the Tutor</div>

                        <div class="rating-group">
                            <label class="rating-label">Punctuality</label>
                            <div class="stars">
                                <input type="radio" name="punctuality" value="5" id="p5"><label for="p5"></label>
                                <input type="radio" name="punctuality" value="4" id="p4"><label for="p4"></label>
                                <input type="radio" name="punctuality" value="3" id="p3"><label for="p3"></label>
                                <input type="radio" name="punctuality" value="2" id="p2"><label for="p2"></label>
                                <input type="radio" name="punctuality" value="1" id="p1"><label for="p1"></label>
                            </div>
                            <div class="rating-value" id="punctuality-value"></div>
                        </div>

                        <div class="rating-group">
                            <label class="rating-label">Teaching Quality</label>
                            <div class="stars">
                                <input type="radio" name="teaching" value="5" id="t5"><label for="t5"></label>
                                <input type="radio" name="teaching" value="4" id="t4"><label for="t4"></label>
                                <input type="radio" name="teaching" value="3" id="t3"><label for="t3"></label>
                                <input type="radio" name="teaching" value="2" id="t2"><label for="t2"></label>
                                <input type="radio" name="teaching" value="1" id="t1"><label for="t1"></label>
                            </div>
                            <div class="rating-value" id="teaching-value"></div>
                        </div>

                        <div class="rating-group">
                            <label class="rating-label">Communication</label>
                            <div class="stars">
                                <input type="radio" name="communication" value="5" id="c5"><label for="c5"></label>
                                <input type="radio" name="communication" value="4" id="c4"><label for="c4"></label>
                                <input type="radio" name="communication" value="3" id="c3"><label for="c3"></label>
                                <input type="radio" name="communication" value="2" id="c2"><label for="c2"></label>
                                <input type="radio" name="communication" value="1" id="c1"><label for="c1"></label>
                            </div>
                            <div class="rating-value" id="communication-value"></div>
                        </div>

                        <div class="rating-group">
                            <label class="rating-label">Subject Knowledge</label>
                            <div class="stars">
                                <input type="radio" name="knowledge" value="5" id="k5"><label for="k5"></label>
                                <input type="radio" name="knowledge" value="4" id="k4"><label for="k4"></label>
                                <input type="radio" name="knowledge" value="3" id="k3"><label for="k3"></label>
                                <input type="radio" name="knowledge" value="2" id="k2"><label for="k2"></label>
                                <input type="radio" name="knowledge" value="1" id="k1"><label for="k1"></label>
                            </div>
                            <div class="rating-value" id="knowledge-value"></div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="form-section">
                        <div class="section-title">How satisfied are you with KEEP TUTORS?</div>
                        <div class="dropdown-group">
                            <label class="rating-label">Overall Service Experience</label>
                            <div class="custom-select">
                                <div class="select-selected" id="selectedOption">
                                    <span class="placeholder">Select your satisfaction level</span>
                                </div>
                                <div class="select-items" id="selectItems">
                                    <div class="select-item" data-value="Excellent">
                                        <span class="item-number">1</span>
                                        <span class="item-emoji">üåü</span>
                                        <span class="item-text">Excellent ‚Äì Very professional and satisfied with the tutor and service</span>
                                    </div>
                                    <div class="select-item" data-value="Good">
                                        <span class="item-number">2</span>
                                        <span class="item-emoji">üëç</span>
                                        <span class="item-text">Good ‚Äì Satisfied, but there's some room for improvement</span>
                                    </div>
                                    <div class="select-item" data-value="Average">
                                        <span class="item-number">3</span>
                                        <span class="item-emoji">üòê</span>
                                        <span class="item-text">Average ‚Äì It was okay, not great or poor</span>
                                    </div>
                                    <div class="select-item" data-value="Poor">
                                        <span class="item-number">4</span>
                                        <span class="item-emoji">üëé</span>
                                        <span class="item-text">Poor ‚Äì Not satisfied with the tutor or service</span>
                                    </div>
                                    <div class="select-item" data-value="Very Poor">
                                        <span class="item-number">5</span>
                                        <span class="item-emoji">üò°</span>
                                        <span class="item-text">Very Poor ‚Äì Extremely dissatisfied with the experience</span>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="service" id="serviceInput" value="">
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="form-section">
                        <div class="section-title">Would you recommend KEEP TUTORS?</div>
                        <div class="recommend-options">
                            <div class="recommend-option">
                                <input type="radio" name="recommend" value="Yes" id="rYes"><label for="rYes">Yes</label>
                            </div>
                            <div class="recommend-option">
                                <input type="radio" name="recommend" value="Maybe" id="rMaybe"><label for="rMaybe">Maybe</label>
                            </div>
                            <div class="recommend-option">
                                <input type="radio" name="recommend" value="No" id="rNo"><label for="rNo">No</label>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="form-section">
                        <div class="section-title">Additional Comments</div>
                        <textarea name="comments" placeholder="Share any additional feedback about your experience..."></textarea>
                    </div>

                    <div class="form-section">
                        <div class="section-title">Suggestions for Improvement</div>
                        <textarea name="suggestions" placeholder="How can we improve our service?"></textarea>
                    </div>

                    <button type="submit" class="submit-btn">Submit Feedback</button>
                </form>
            </div>

            <div class="success-state" id="successState">
                <div class="success-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2>Thank You!</h2>
                <p>Your feedback has been submitted successfully. We appreciate you taking the time to share your experience.</p>
            </div>
        </div>
    </div>

    <script>
        const ratingLabels = { 1: 'Poor', 2: 'Fair', 3: 'Good', 4: 'Very Good', 5: 'Excellent' };
        const urlParams = new URLSearchParams(window.location.search);
        const feedbackId = urlParams.get('id');

        const loadingState = document.getElementById('loadingState');
        const formState = document.getElementById('formState');
        const successState = document.getElementById('successState');
        const invalidState = document.getElementById('invalidState');
        const submittedState = document.getElementById('submittedState');
        const invalidMessage = document.getElementById('invalidMessage');
        const errorMessage = document.getElementById('errorMessage');
        const form = document.getElementById('feedbackForm');
        const formTitle = document.getElementById('formTitle');
        const tutorSectionTitle = document.getElementById('tutorSectionTitle');
        const selectSelected = document.getElementById('selectedOption');
        const selectItems = document.getElementById('selectItems');
        const serviceInput = document.getElementById('serviceInput');

        let recordId = null;

        async function initPage() {
            if (!feedbackId) {
                showInvalidState('This feedback link appears to be invalid. Please use the link sent to you.');
                return;
            }

            try {
                const response = await fetch(`/api/feedback?id=${feedbackId}`);
                const result = await response.json();

                if (!response.ok) {
                    showInvalidState(result.error || 'Failed to load feedback form.');
                    return;
                }

                if (result.status === 'Submitted') {
                    showSubmittedState();
                    return;
                }

                recordId = result.recordId;
                const feedbackType = result.type || 'tuition';
                
                if (feedbackType === 'demo') {
                    formTitle.textContent = 'Demo Feedback';
                    tutorSectionTitle.textContent = 'Rate the Demo Session';
                    document.title = 'Demo Feedback - KEEP TUTORS';
                } else {
                    formTitle.textContent = 'Tuition Feedback';
                    tutorSectionTitle.textContent = 'Rate the Tutor';
                    document.title = 'Tuition Feedback - KEEP TUTORS';
                }

                showFormState();
            } catch (error) {
                showInvalidState('Something went wrong. Please try again later.');
            }
        }

        function showInvalidState(msg) { loadingState.classList.remove('active'); invalidMessage.textContent = msg; invalidState.classList.add('active'); }
        function showSubmittedState() { loadingState.classList.remove('active'); submittedState.classList.add('active'); }
        function showFormState() { loadingState.classList.remove('active'); formState.classList.add('active'); }
        function showError(msg) { errorMessage.textContent = msg; errorMessage.classList.add('active'); window.scrollTo({ top: 0, behavior: 'smooth' }); }

        document.querySelectorAll('.stars input').forEach(input => {
            input.addEventListener('change', (e) => {
                const name = e.target.name;
                const value = e.target.value;
                const el = document.getElementById(`${name}-value`);
                if (el) el.textContent = `${value}/5 - ${ratingLabels[value]}`;
            });
        });

        const serviceOptions = { 
            'Excellent': { emoji: 'üåü', text: 'Excellent ‚Äì Very professional and satisfied with the tutor and service' },
            'Good': { emoji: 'üëç', text: 'Good ‚Äì Satisfied, but there\'s some room for improvement' },
            'Average': { emoji: 'üòê', text: 'Average ‚Äì It was okay, not great or poor' },
            'Poor': { emoji: 'üëé', text: 'Poor ‚Äì Not satisfied with the tutor or service' },
            'Very Poor': { emoji: 'üò°', text: 'Very Poor ‚Äì Extremely dissatisfied with the experience' }
        };

        selectSelected.addEventListener('click', (e) => {
            e.stopPropagation();
            selectSelected.classList.toggle('active');
            selectItems.classList.toggle('show');
        });

        document.querySelectorAll('.select-item').forEach(item => {
            item.addEventListener('click', () => {
                const value = item.dataset.value;
                const option = serviceOptions[value];
                serviceInput.value = value;
                selectSelected.innerHTML = `<div class="selected-text"><span class="selected-emoji">${option.emoji}</span><span class="selected-label">${option.text}</span></div>`;
                document.querySelectorAll('.select-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                selectSelected.classList.remove('active');
                selectItems.classList.remove('show');
            });
        });

        document.addEventListener('click', () => { selectSelected.classList.remove('active'); selectItems.classList.remove('show'); });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const email = formData.get('email')?.trim();

            const data = {
                id: feedbackId,
                recordId: recordId,
                email: email,
                punctuality: formData.get('punctuality'),
                teaching_quality: formData.get('teaching'),
                communication: formData.get('communication'),
                subject_knowledge: formData.get('knowledge'),
                service_satisfaction: serviceInput.value,
                would_recommend: formData.get('recommend'),
                comments: formData.get('comments') || '',
                suggestions: formData.get('suggestions') || ''
            };

            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError('Please enter a valid email address.'); return; }
            if (!data.punctuality || !data.teaching_quality || !data.communication || !data.subject_knowledge) { showError('Please complete all tutor rating fields.'); return; }
            if (!data.service_satisfaction) { showError('Please select your satisfaction level with KEEP TUTORS.'); return; }
            if (!data.would_recommend) { showError('Please select whether you would recommend us.'); return; }

            errorMessage.classList.remove('active');
            form.parentElement.classList.add('loading');
            form.querySelector('.submit-btn').disabled = true;

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (response.ok) {
                    formState.classList.remove('active');
                    successState.classList.add('active');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    throw new Error(result.error || 'Failed to submit feedback');
                }
            } catch (error) {
                showError(error.message || 'Something went wrong. Please try again.');
                form.parentElement.classList.remove('loading');
                form.querySelector('.submit-btn').disabled = false;
            }
        });

        initPage();
    </script>
</body>
</html>
